<html>
<head>
    <script type="text/javascript">
        let fields = [
            'environment',
            'instance',
            'locale',
            'region',
            'stage',
            'oktaappid',
            'oktaappurl'
        ];

        String.prototype.toDashed = function() {
            return (this.length) ? '-' + this : '';
        };

        window.onload = function() {
            fields.forEach(elem => {
                document.getElementById(elem).value = window.sessionStorage.getItem(elem);
            });
        };

        function execute() {
            fields.forEach(elem => {
                window.sessionStorage.setItem(elem, document.getElementById(elem).value);
            });

            let environment = document.getElementById('environment').value;
            let instance = document.getElementById('instance').value;
            let locale = document.getElementById('locale').value;
            let region = document.getElementById('region').value;
            let stage = document.getElementById('stage').value;
            let oktaappid = document.getElementById('oktaappid').value;
            let oktaappurl = document.getElementById('oktaappurl').value;

            let azureResourceGroup = `SSODemoApp-${environment}`;
            let azureName = `amway-demo-${environment.toLowerCase()}${stage.toDashed().toLowerCase()}-${instance.toLowerCase()}`;
            let azureWebsiteName = `https://${azureName}.azurewebsites.net`;
            let azureCert =
                (environment === 'Test') ? '04EE9975E7EEDB5749C3F13F546EB99611A853D9' :
                (environment === 'QA') ? '6C0F5EA2F9FB716264040C39A4A2985D4F4FA49A' : '';

            let oktaRedirectUrl =
                (!stage && region === 'USEast1') ? `https://account-${environment.toLowerCase()}.amwayglobal.com` :
                    `https://account-${locale.toLowerCase()}-${region.toLowerCase()}-${environment.toLowerCase()}${stage.toDashed().toLowerCase()}.preprod.corp.amway.net/`;
            let oktaSAMLUrl = `${azureWebsiteName}/Login.ashx`;
            let oktaOrg = `https://amwayconnect${environment.toDashed().toLowerCase()}.${(environment === 'Production') ? 'okta' : 'oktapreview'}.com`;

            let netConfigName = `${environment}${stage.toDashed()}`;
            let netSSOUrl = `${oktaOrg}/app/${oktaappurl}/${oktaappid}/sso/saml?clientapp=demoapp-${instance.toLowerCase()}`;
            let netSLOUrl = `${oktaOrg}/app/${oktaappurl}/${oktaappid}/slo/saml`;

            let area = document.getElementById('area');
            let body = document.getElementsByTagName('body')[0];

            let oktaTemplate = `{
  "label": "DemoApp - ${environment}${stage.toDashed()} - ${instance}",
  "accessibility": {
    "selfService": false,
    "errorRedirectUrl": null,
    "loginRedirectUrl": "${oktaRedirectUrl}"
  },
  "visibility": {
    "autoSubmitToolbar": false,
    "hide": {
      "iOS": true,
      "web": true
    }
  },
  "signOnMode": "SAML_2_0",
  "settings": {
    "signOn": {
      "defaultRelayState": "",
      "ssoAcsUrl": "${oktaSAMLUrl}",
      "idpIssuer": "http://www.okta.com/$\{org.externalKey\}",
      "audience": "${oktaSAMLUrl}",
      "recipient": "${oktaSAMLUrl}",
      "destination": "${oktaSAMLUrl}",
      "subjectNameIdTemplate": "$\{user.userName\}",
      "subjectNameIdFormat": "urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress",
      "responseSigned": true,
      "assertionSigned": true,
      "signatureAlgorithm": "RSA_SHA256",
      "digestAlgorithm": "SHA256",
      "honorForceAuthn": true,
      "authnContextClassRef": "urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport",
      "spIssuer": null,
      "requestCompressed": false,
      "attributeStatements": [
        {
          "type": "EXPRESSION",
          "name": "PartyId",
          "namespace": "urn:oasis:names:tc:SAML:2.0:attrname-format:unspecified",
          "values": [
            "user.partyId"
          ]
        }
      ]
    }
  }
}`;
            let azureTemlate = `azure webapp create ${azureResourceGroup} ${azureName} eastus /subscriptions/410adfbf-b262-44c8-a99d-a884e65e97d3/resourceGroups/${azureResourceGroup}/providers/Microsoft.Web/serverFarms/${azureResourceGroup}

azure webapp config appsettings set ${azureResourceGroup} ${azureName} SCM_BUILD_ARGS=-p:Configuration=${netConfigName},WEBSITE_LOAD_CERTIFICATES=${azureCert}`;

            let netWebConfigTemplate = (!oktaappid) ? 'You must first set the okta app ID and URL values' : `<?xml version="1.0"?>

<!-- For more information on using Web.config transformation visit http://go.microsoft.com/fwlink/?LinkId=301874 -->
<!--For easy testing, go to https://webconfigtransformationtester.apphb.com/-->

<configuration xmlns:xdt="http://schemas.microsoft.com/XML-Document-Transform">
	<appSettings>
	    <add key="DemoAppURL" value="${azureWebsiteName}" />
	    <add key="OktaOrg" value="${oktaOrg}" xdt:Transform="SetAttributes(value)" xdt:Locator="Match(key)" />
		<add key="OktaLoginURL" value="${netSSOUrl}" xdt:Transform="SetAttributes(value)" xdt:Locator="Match(key)" />
		<add key="OktaLogoutURL" value="${oktaOrg}/login/signout?fromURI=${encodeURIComponent(azureWebsiteName + '/Account/Logout')}" xdt:Transform="SetAttributes(value)" xdt:Locator="Match(key)" />
		<add key="ChangePasswordLink" value="${oktaRedirectUrl}/my-account/change-password" xdt:Transform="SetAttributes(value)" xdt:Locator="Match(key)" />
		<add key="AppColor" value="black" xdt:Transform="SetAttributes(value)" xdt:Locator="Match(key)" />
	</appSettings>
	<saml2>
		<allowedAudienceUris>
			<audience uri="${azureWebsiteName}/Login.ashx" xdt:Transform="SetAttributes(uri)" />
		</allowedAudienceUris>
		<serviceProvider id="urn:SPName" server="https://www.example.com">
			<signingCertificate findValue="E=brian.hibma@amway.com, C=US, CN=dotnet-demo-ca${(environment !== 'Test') ? environment.toDashed().toLowerCase() : ''}" storeLocation="CurrentUser" storeName="My" x509FindType="FindBySubjectDistinguishedName" xdt:Transform="SetAttributes(findValue)" />
		</serviceProvider>
		<identityProviders metadata="Config/${environment.toLowerCase()}-${instance.toLowerCase()}" xdt:Transform="SetAttributes">
			<!-- The 'id' value below must match the 'entityID' field of a metadata file below the path in the 'metadata' property in the parent XML config node  -->
			<add id="http://www.okta.com/${oktaappid}" xdt:Transform="SetAttributes(id)">
				<endpoints>
					<endpoint type="SignOn" url="${netSSOUrl}" binding="Post" xdt:Transform="Replace" xdt:Locator="Match(type)" />
					<endpoint type="Logout" url="${netSLOUrl}" binding="Post" xdt:Transform="Replace" xdt:Locator="Match(type)" />
				</endpoints>
			</add>
		</identityProviders>
	</saml2>
</configuration>
`;
            let netMetadata = (!oktaappid) ? 'You must first set the okta app ID and URL values' : `<?xml version="1.0" encoding="UTF-8"?><md:EntityDescriptor xmlns:md="urn:oasis:names:tc:SAML:2.0:metadata" entityID="http://www.okta.com/${oktaappid}"><md:IDPSSODescriptor WantAuthnRequestsSigned="false" protocolSupportEnumeration="urn:oasis:names:tc:SAML:2.0:protocol"><md:KeyDescriptor use="signing"><ds:KeyInfo xmlns:ds="http://www.w3.org/2000/09/xmldsig#"><ds:X509Data><ds:X509Certificate>MIIDrjCCApagAwIBAgIGAVoqD3ZsMA0GCSqGSIb3DQEBBQUAMIGXMQswCQYDVQQGEwJVUzETMBEG
A1UECAwKQ2FsaWZvcm5pYTEWMBQGA1UEBwwNU2FuIEZyYW5jaXNjbzENMAsGA1UECgwET2t0YTEU
MBIGA1UECwwLU1NPUHJvdmlkZXIxGDAWBgNVBAMMD2Ftd2F5Y29ubmVjdC1xYTEcMBoGCSqGSIb3
DQEJARYNaW5mb0Bva3RhLmNvbTAeFw0xNzAyMTAyMjA0NDBaFw0yNzAyMTAyMjA1NDBaMIGXMQsw
CQYDVQQGEwJVUzETMBEGA1UECAwKQ2FsaWZvcm5pYTEWMBQGA1UEBwwNU2FuIEZyYW5jaXNjbzEN
MAsGA1UECgwET2t0YTEUMBIGA1UECwwLU1NPUHJvdmlkZXIxGDAWBgNVBAMMD2Ftd2F5Y29ubmVj
dC1xYTEcMBoGCSqGSIb3DQEJARYNaW5mb0Bva3RhLmNvbTCCASIwDQYJKoZIhvcNAQEBBQADggEP
ADCCAQoCggEBAOWoJBFSHnrJvVKacHUCPqsz0QDUHL8cDhGFJtp5fh4CkPtmoshDLyxbfrayZWDb
68vxRN3NQJOoMXSgONKhDBllxLBNam+X//Wt57eAUitX66IKiDEdK48c4ivtXsS+GY7srX37f2uC
PsLM+BU+3dMrd8/LKHMcU/lVdDbZMuVUq3IN7SW+2mEzU5yWtAwzM7MvKxv3PmxYp0uP7mEEfAqZ
H5HkdChwItisvAuoGKgpaz9wfIH71xYlvZVEzDzt0H8PPbLz1GSzkFSeTdTNNcVX+5xWO73s4Iym
8xIqBXSDx4WRaMtUFiPfC9hm9g7gijnE+loXbsrYPdYb97GFPAkCAwEAATANBgkqhkiG9w0BAQUF
AAOCAQEAFT2Hl6YWdYlllZn1mLTPHbDAiHPfSdFywWZF0XiNMPRtuwcFmKp86VOTYjiafEZFR5qp
R91OK8Ci7Iu4Uwcq4QaSDYXTGIlivsFRAmxsCRAQKwoeQMy4tKEyWOgUMpEF7qkie9wX9OnooEbJ
AxaDZZUCZ8yaU6hgeYAT7Kofhb+A5sJkZMoWHOd2db0mnTiss7j9Pdo1jAXfgB+XzNnLCdkXHx5H
imYcNtbbu0r6kEgWrr++9+butcCXAp1qdG+MfxcuVLvR5uaPM+PdHTain/CX6Y7AunCNWYl+6Qnz
iRa1lzQuQVTSg5dticjr2OzZh+e9nHiwjC/Xi4kug0HnGA==</ds:X509Certificate></ds:X509Data></ds:KeyInfo></md:KeyDescriptor><md:SingleLogoutService Binding="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST" Location="${netSLOUrl}"/><md:SingleLogoutService Binding="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect" Location="${netSLOUrl}"/><md:NameIDFormat>urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress</md:NameIDFormat><md:NameIDFormat>urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified</md:NameIDFormat><md:SingleSignOnService Binding="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST" Location="${netSSOUrl}"/><md:SingleSignOnService Binding="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect" Location="${netSSOUrl}"/></md:IDPSSODescriptor></md:EntityDescriptor>`;

            document.getElementById('oktaArea').value = oktaTemplate;
            document.getElementById('azureArea').value = azureTemlate;
            document.getElementById('netWebConfigArea').value = netWebConfigTemplate;
            document.getElementById('netMetadataArea').value = netMetadata;

        }
    </script>
</head>
<body style="margin: 15px;">
<div>
    <p>Environment: <select id="environment">
        <option>Test</option>
        <option>QA</option>
        <option>Production</option>
    </select></p>
    <p>Instance: <select id="instance">
        <option>Walter</option>
        <option>TheDude</option>
    </select></p>
    <p>Locale: <select id="locale">
        <option>Americas</option>
        <option>Asia</option>
        <option>Europe</option>
    </select></p>
    <p>Region: <select id="region">
        <option>USEast1</option>
        <option>USWest2</option>
    </select></p>
    <p>Stage: <select id="stage">
        <option></option>
        <option>Blue1</option>
        <option>Green1</option>
    </select></p>
    <p>Okta App ID: <input id="oktaappid" type="text"/></p>
    <p>Okta App URL Value: <input id="oktaappurl" type="text"/></p>
    <button onclick="execute()">Submit</button>

    <h2>Okta App Setup</h2>
    <p>Following Okta app creation, you must still setup the single logout configuration and certificate as well as the Okta groups configuration.  Also note the app ID which is needed for the .NET configuration.</p>
    <textarea id="oktaArea" rows="25" cols="150"></textarea>

    <h2>Azure Setup</h2>
    <textarea id="azureArea" rows="10" cols="150"></textarea>

    <h2>.NET Setup</h2>
    <textarea id="netWebConfigArea" rows="25" cols="150"></textarea>

    <h2>.NET Metadata</h2>
    <textarea id="netMetadataArea" rows="25" cols="150"></textarea>
</div>
</body>
</html>